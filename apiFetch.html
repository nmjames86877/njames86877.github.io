<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Fetch and Excel Update</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <button id="fetchDataBtn">Fetch Data and Update Excel</button>
    <p id="resultMessage"></p>
    <script>
        document.getElementById('fetchDataBtn').addEventListener('click', fetchData);

        function fetchData() {
            fetch('https://www.consumerfinance.gov/data-research/consumer-complaints/search/api/v1/?date_received_min=2024-12-01')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ${response.status}');
                    }
                    return response.json();
                });
                .then(data => {
                    const complaints = data.hits.hits.map(item => item._source);
                    updateExcelFile(complaints);
                });
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('resultMessage').textContent = 'Error fetching data: ${error.message}';
                });
        }

        function updateExcelFile(data) {
            fetch('https://1drv.ms/x/c/cd6cbe893ea13b4b/ESYZkMUoEExHoJphONk86wYBGF-PvDlRZbm-UBhsJm0QBg')
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                    let worksheet = workbook.Sheets['Complaints'];

                    if (!worksheet) {
                        worksheet = XLSX.utils.json_to_sheet([]);
                        XLSX.utils.book_append_sheet(workbook, worksheet, 'Complaints');
                    }

                    const headers = [
                        "company", "company_public_response", "company_response", "complaint_id",
                        "complaint_what_happened", "consumer_consent_provided", "consumer_disputed",
                        "date_received", "date_sent_to_company", "has_narrative", "issue", "product",
                        "state", "sub_issue", "sub_product", "submitted_via", "tags", "timely", "zip_code"
                    ];

                    const newData = data.map(item => headers.map(header => item[header]));

                    if (!worksheet['!ref']) {
                        XLSX.utils.sheet_add_aoa(worksheet, [headers], {origin: 'A1'});
                    }

                    XLSX.utils.sheet_add_aoa(worksheet, newData, {origin: -1});

                    XLSX.writeFile(workbook, 'updated_complaints.xlsx');
                    document.getElementById('resultMessage').textContent = 'Excel file updated successfully.';
                });
                .catch(error => {
                    console.error('Error updating Excel file:', error);
                    document.getElementById('resultMessage').textContent = 'Error updating Excel file: ${error.message}';
                });
        }
    </script>
</body>
</html>